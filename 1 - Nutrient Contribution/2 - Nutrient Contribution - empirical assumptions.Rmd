---
title: "2 - Total Nutrient Contribution"
subtitle: "Assessment of contributions based on assumptions derived from empirical data"
author: "Anıl A. Tellbüscher"
date: '2022-07-04'
output: html_document
---

```{r include=FALSE}
# Load packages
library(XLConnect)
library(tidyverse)
library(NADA)
```



# General
It was found that the statement, that the fish feed provides most of the plant nutrients, should be seen as a qualitative instead of a quantitative statement (Delaide et al. 2016). For the formulation of fish feeds tailored for aquaponic systems, it is important to find out which nutrients are generally variable in their input concentrations, with the variability being site-specific. Otherwise, it might be the case that a tailored aquafeed is oversupplying a nutrient in one scenario, while the same nutrient is not present in sufficient amounts in another scenario. This shall be avoided. Due to the fact that the stated paper only analysed water originating from one source, it does not account for variability among different locations. The composition of water is constrained by the EU Water Directive, but can vary within the accepted threshold value. The aim of the following section is thus to estimate the variability by using a range of waters from different sources. By doing this, a pre-selection of candidate nutrients for the development of a tailored aquafeed is made.

The contribution of the different nutrient sources to the total nutrient input is based on daily inputs of feed, water and auxiliary chemicals. The latter are used for pH control. Assumptions have to be made based on average system parameters such as 

- rearing volume of the system
- total volume of the system
- stocking density of the system
- total biomass
- daily feeding rate
- daily water exchange rate
- total daily feed input
- total daily water input



# 1. Generate assumptions

## 1.1 Rearing parameters

```{r}
# Load Workbook
masterfile_nutrients <- loadWorkbook("/Users/anil/Library/CloudStorage/OneDrive-JihočeskáuniverzitavČeskýchBudějovicích/General/Aquaponics - Masterfile Nutrients.xlsx")
```



### 1.1.1 Load rearing data and feeding data

```{r}
assumption_data_general <- readWorksheet(masterfile_nutrients, sheet = 'general', header = TRUE, startRow = 1)
assumption_data_rearing <- readWorksheet(masterfile_nutrients, sheet = 'rearing', header = TRUE, startRow = 2)
```



### 1.1.2 Load feeding data

```{r}
assumption_data_feed <- readWorksheet(masterfile_nutrients, sheet = 'feedIN', header = TRUE, startRow = 2)
```



### 1.1.3 Derive assumptions
- the mean volume of the rearing compartment (m3) which is determining the total biomass in the system due to the fact that the stocking density depends on the volume of the rearing tanks instead of the total system volume
- the mean daily feed input (kg) based on the feeding rate given
- the mean total volume of freshwater added (m3), based on the water exchange rate reported
- the mean water exchange volume (L) per mass unit of feed (kg) added to the system as an indicator of the amount of freshwater that is used.
```{r}
assumptions_data <- assumption_data_rearing %>% 
  
  
  left_join(assumption_data_feed, by = c("Reference_ID", "Treatment_ID")) %>% 
  
  left_join(assumption_data_general, by = c("Reference_ID", "Treatment_ID")) %>% 
  
  
  rename('tankV' = 'Vtank_.m3.', 'tankN' = 'Ntank', 'totalV' = 'Vtot_.m3.', 'density' = 'Density_.kgm3.', 'biomass' = 'totBiomass_.kgsystem.', 'exchRate' = 'exchRate_.percd.', 'FR' = 'FR_..BW.', 'days' = 'duration_.d.', 'IBW' = 'IBW_.g.') %>% 
    
    
  filter(
    experiment != 'remineralisation' & 
    coupling != 'permanent' & 
    Reference_ID != 'Siqwepu2020'
  ) %>% 
  
  
  select('Reference_ID', 'Treatment_ID', 'days', 'pH', 'tankV','tankN', 'totalV', 'density', 'biomass', 'exchRate', 'FR', 'exchRate', 'IBW') %>% 
  
  # Calculate some assumptions
  mutate(
    rearingV = tankV * tankN,
    dailyFeed = biomass * (FR),
    # totalV = tankV * tankN + miscV,
    dailyFreshwater = totalV * (exchRate),
    waterEx_perFeed = (dailyFreshwater * 1e3) / dailyFeed # L
  ) %>% 
  
  
  drop_na(density) %>% 

  
  print()

# Count observations
assumptions_data %>% 
  summarise(
    publications = length(unique(Reference_ID)),
    observations = n()
  ) %>% 
  
  print()

# Generate summary values
assumptions_data <- assumptions_data %>% 
  
  summarise(
    RearingV = mean(rearingV, na.rm = TRUE),
    #sdRearingV = sd(rearingV, na.rm = TRUE),
    TotalV = mean(totalV, na.rm = TRUE),
    #sdTotalV = sd(totalV, na.rm = T),
    IBW = mean(IBW, na.rm = TRUE),
    StockingDensity = mean(density, na.rm = TRUE),
    #sdStockingDensity = sd(density, na.rm = TRUE),
    Biomass = mean(biomass, na.rm = TRUE),
    #sdBiomass = sd(biomass, na.rm = TRUE),
    DailyFeed = mean(dailyFeed, na.rm = TRUE),
    #sdDailyFeed = sd(dailyFeed, na.rm = TRUE),
    WaterExchange = mean(exchRate, na.rm = TRUE) * 100,
    #sdWaterExchange = sd(exchRate, na.rm = TRUE) * 100,
    DailyFreshwater = mean(dailyFreshwater, na.rm = TRUE),
    #sdDailyFreshwater = sd(dailyFreshwater, na.rm = TRUE),
    WaterEx_perFeed = mean(waterEx_perFeed, na.rm = TRUE),
    #sdWaterEx_perFeed = sd(waterEx_perFeed, na.rm = TRUE),
    pH = mean(pH, na.rm = TRUE)
  ) %>% 
  
  print()

#rm(assumption_data_feed, assumption_data_rearing)
```

By limiting to publications that are not remineralisation systems and, in case of aquaponic systems, only representing the aquaculture unit of on-demand coupled systems, it is ensured that the data is representing the aquaculture conditions in the aquaponic studies.
A total of 51 observations from 21 publications was used for generating the assumptions.





## 1.2 Water data

### 1.2.1 Load water quality data
```{r}
# Load workbook
water_quality <- loadWorkbook(filename = "/Users/anil/Library/CloudStorage/OneDrive-JihočeskáuniverzitavČeskýchBudějovicích/General/Aquaponics - Water Quality.xlsx")
```



```{r include=FALSE}
# Load tap water data
water_data <- readWorksheet(water_quality, 
                      sheet = 'municipalTap', 
                      startRow = 2,
                      endCol = 47
  )

water_data[,grep("belowLimit", colnames(water_data))] <- apply(water_data[,grep("belowLimit", colnames(water_data))], 2, as.logical)

print(water_data)
```



## 1.3 Feed data

### 1.3.1 Load data




# 2. Recalculation of censored data
To estimate the mass contribution of source water and feed to the total amount of nutrients that are entering the system, it is assumed that the RAS operator is using tap water as freshwater source. This is in line with aquaponics being suggested as alternative means of food production in urban areas or in regions suffering from water scarcity. Analysis results from different water treatment plants all over the world, but with focus on Europe, are taken as data input.
Due to the fact that certain nutrients in tap water are below detection limits, the 90% confidence interval was estimated using the Maximum Likelihood Estimation (MLE) method (Statistics for Censored Environmental Data, Helsel 2012). 
Here, data points for the values below detection limit are estimated statistically, based on the distribution of the available values and the detection limits. This approach yields much better estimates of location and distribution statistics than the substitution of values below detection limits by a fixed number.



## 2.1 Convert data
```{r}
# Conversion of data into long format
water_data <- water_data %>% 
  select(-c(Reference_ID:`EC_uS_cm_25degC`)) %>% 
  pivot_longer(
    everything(),
  names_to = c("nutrient", ".value"),
  names_pattern = "(.+)_(.+)*"
    ) %>% 
  mutate(nutrient = as.factor(nutrient)) %>% 
  print()

write.csv2(water_data, file = 'data/water_data.csv')
```



## 2.2 MLE replacement values for censored data
```{r include=FALSE}
# Calculation of Maximum Likelihood estimates and 95% confidence interval for censored tap water quality data
#
# Extract nutrients for looping
object <- levels(water_data$nutrient)
# Create results data frame
results <- data.frame(nutrient = vector(mode = "character"), lconf = vector(mode = "numeric"), hconf = vector(mode = "numeric"))

for (number in 1:length(object)) {
  
  # Create subset for each nutrient
  temp <- filter(water_data, nutrient == object[number]) %>%
    drop_na()
  
  # Create results dataframe with 95% confInts
  results[number,1] <- object[number]
  results[number,2] <- mean(cenmle(temp$mgL, temp$belowLimit, dist = 'gaussian'))[c(3)]
  results[number,3] <- mean(cenmle(temp$mgL, temp$belowLimit, dist = 'gaussian'))[c(4)]
}
```



Next, the concentration values are converted from molecular into elemental concentrations by multiplication of the concentration value with their corresponding conversion factor that is based on the molar mass ratio between the element (e.g. N) and the molecule (e.g. NO3). 



```{r include=FALSE}
# Conversion of molecular into elemental concentrations

object <- c("PO4", "NO2", "NO3", "NH4", "SO4")
convFactor <- c(31/95, 7/23, 7/31, 7/9, 1/3)

for( i in 1:nrow(results)){
  for(number in 1:length(object)){
   if(results$nutrient[i] == object[number]){
     results$lconf[i] <- results$lconf[i] * convFactor[number]
     results$hconf[i] <- results$hconf[i] * convFactor[number]
   } 
  }
}
```



Finally, all nitrogenous compounds are summed up as total inorganic nitrogen (TIN).



```{r include=FALSE}
# Calculation of N from remaining data
temp <- data.frame()
temp[1,1] <- 'TIN'
temp[1,2] <- sum(results$lconf[which(results$nutrient %in% c('NH4', 'NO2', 'NO3'))])
temp[1,3] <- sum(results$hconf[which(results$nutrient %in% c('NH4', 'NO2', 'NO3'))])
colnames(temp) <- colnames(results)
results <- rbind(results, temp)
```



Now, data about average nutrient inclusion rates of fish feeds is used to calculate the 'contribution ratio' for each plant nutrient that is entering the system.



## 2.3 Load digestibility data
The digestibility data is based on assumptions and is not backed up by empirical validation.

```{r include=FALSE}
# Load digestibility data
feed_data <- read.csv2("data/nutrient_contribution.csv")

# Convert classes
feed_data[,1] <- factor(feed_data[,1], levels = c('N', 'P', 'K', 'Ca', 'Mg', 'S', 'B', 'Fe', 'Mn', 'Zn', 'Cu', 'Mo', 'Ni', 'Na'))
feed_data[,2:5] <- apply(feed_data[,2:5], 2, as.numeric)
```



# 3. Plot total contribution data

## 3.1 Create plot dataset
```{r}
plotdata <- results %>% 
  mutate(nutrient = factor(nutrient,
                           levels = c('TIN', 'PO4', 'K', 'Ca', 'Mg', 'SO4', 'B', 'Fe', 'Mn', 'Zn', 'Cu', 'Mo', 'Ni', 'Na', 'NH4', 'NO2', 'NO3'),
                           labels = c('N', 'P', 'K', 'Ca', 'Mg', 'S', 'B', 'Fe', 'Mn', 'Zn', 'Cu', 'Mo', 'Ni', 'Na','NH4', 'NO2', 'NO3'))) %>% 
  left_join(feed_data, by = c('nutrient' = 'compound')) %>% 
  drop_na(feedComp_g.kg) %>% 
  mutate(
    `Water 5% Contribution` = assumptions_data$DailyFreshwater * lconf,
    `Water 95% Contribution` = assumptions_data$DailyFreshwater * hconf,
    FeedContribution = assumptions_data$DailyFeed * feedComp_g.kg
  ) %>% 
  select(c(nutrient, `Water 5% Contribution`, `Water 95% Contribution`, FeedContribution)) %>% 
  pivot_longer(cols = c(`Water 5% Contribution`, `Water 95% Contribution`, FeedContribution),
               names_to = 'Contribution',
               names_pattern = '(.*)Contribution',
               values_to = 'Total')

plotdata$Total <- if_else(plotdata$Total > 0, plotdata$Total, 0)

print(plotdata)
```



## 3.2 Create plots

### 3.2.1 Total nutrient contribution
Given the data about average plant nutrient loadings per unit of water and feed and the initial assumptions about the daily exchanged volume of water and feed fed, it is possible to calculate the total mass of nutrients that are introduced into the system every day.

```{r}
plotdata %>%
    mutate(Contribution = factor(Contribution, 
                            levels = c('Feed', 'Water 95% ', 'Water 5% '),
                            labels = c('Feed', 'Water 95%', 'Water 5%'))
         ) %>% 
  
  
  
ggplot(aes(x = nutrient, y = Total, fill = Contribution)) + 
  geom_col(position = 'fill') + 
  geom_hline(yintercept = c(0.25, 0.5, 0.75), linetype = "dashed", alpha = 0.75) + 
  labs(
    title = "The source of plant nutrients in Aquaponics"
    ,subtitle = paste(round(assumptions_data$WaterExchange), "% water exchange, digestibility not considered", sep = "")
    ,x = ""
    ,y = "Relative nutrient contribution"
    ,fill = "Source"
  ) +
  theme_minimal() + 
  scale_fill_manual(values=c("brown",
                             "lightblue",
                             "darkblue"))
```

A visual presentation of the data based on the percentage contribution of both sources to the total introduced nutrients gives a picture that differs from the consensus that the majority of nutrients is introduced into the system via feed. 
Even though the most important plant nutrients (N, P, K) and all micronutrients, excluding boron, are mostly originating from the feed, source water would provide 25 to 50% of calcium, sulfur and boron in 90% of the cases.





### 3.2.2 Indigestible nutrient contribution
An important aspect that should not be forgotten is that the livestock in the RAS has to be considered a nutrient sink. When thinking about the total nutrient contribution to the system, it is, as showed, scenario-dependently true that feed is introducing the highest share of nutrients to the system. However, it must be taken into account that animal feed is only partly excreted, while the other part is retained in the animal in form of biomass. If we want to fertilize the plants, it is thus of importance to consider only the nutrients that are leaving the RAS unit. To do so, the nutrient retention by the livestock is taken into account in the next step.

```{r include=FALSE}
plotdata <- plotdata %>% 
  pivot_wider(
    names_from = Contribution,
    values_from = Total
  ) %>% 
  left_join(feed_data, by = c('nutrient' = 'compound')) %>% 
  select(c(nutrient, `Water 5% `, `Water 95% `, Feed, digestibility)) %>% 
  mutate(
    Feed = Feed * digestibility
  ) %>% 
  select(-digestibility) %>% 
  pivot_longer(
    `Water 5% `:Feed,
    names_to = 'Contribution',
    values_to = 'Total'
  ) %>% 
  mutate(Contribution = factor(Contribution, 
                          levels = c('Feed', 'Water 95% ', 'Water 5% '),
                          labels = c('Feed', 'Water 95%', 'Water 5%')),
         nutrient = factor(nutrient,
                           levels = c('N', 'P', 'K', 'Ca', 'Mg', 'S', 'B', 'Fe', 'Mn', 'Zn', 'Cu', 'Mo', 'Ni', 'Na'))
         ) 
```  



```{r echo=FALSE}
plotdata %>% 
ggplot(aes(x = nutrient, y = Total, fill = Contribution)) + 
  geom_col(position = 'fill') + 
  geom_hline(yintercept = c(0.25, 0.5, 0.75), linetype = "dashed", alpha = 0.75) + 
  labs(
    title = "The source of plant nutrients in Aquaponics"
    ,subtitle = paste(round(assumptions_data$WaterExchange), "% water exchange, digestibility considered", sep = "")
    ,x = ""
    ,y = "Nutrient contribution (%)"
    ,fill = "Source"
  ) + 
  theme_minimal() + 
  scale_fill_manual(values=c("brown",
                             "lightblue",
                             "darkblue"))
```

As shown, taking the retention into consideration increases the share that source water has of the total amount of nutrients present in the system. However, the absolute amount of nutrients within the system decreases as it is now part of the fish in form of biomass and not available for plant growth any longer.



# 4. True Contribution

